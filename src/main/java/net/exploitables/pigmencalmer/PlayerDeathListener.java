package net.exploitables.pigmencalmer;

import org.bukkit.Location;
import org.bukkit.World;
import org.bukkit.entity.PigZombie;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.entity.PlayerDeathEvent;

import java.util.Collection;

public class PlayerDeathListener implements Listener {

    @EventHandler
    public void onPlayerDeath(PlayerDeathEvent event) {
        // If the player died in the nether
        if (event.getEntity().getWorld().getEnvironment().equals(World.Environment.NETHER)) {
            Collection<PigZombie> allPigMen = event.getEntity().getWorld().getEntitiesByClass(PigZombie.class);
            Location playerLocation = event.getEntity().getLocation();

            for (PigZombie pigMan : allPigMen) {
                // TODO: Make this a config variable

                /*  Using an arbitrary number as I don't know the actual aggro distance when attacking a zombie pigman
                    Server default render distance is 12 chunks, 12 * 16 = 192,
                        so anything outside that distance would be unloaded.
                    According to https://minecraft.gamepedia.com/Spawn#Spawn_cycle
                        mobs spawn in a 15x15 chunk radius around the player, 15 x 16 = 240

                    Using server default radius should be acceptable, as this is intended to be used on a server.

                    Why not just do all of them? Different players may be in different parts of the nether.
                    Why not check for the ones that are angry at the player that died? I don't see a method to determine
                        that in this API version (1.16.1-R0.1-SNAPSHOT)
                */

                if (playerLocation.distance(pigMan.getLocation()) < 192) {
                    // No more angry! The fix I've been wanting since I played MC on the 360 in 2012 ...
                    // TODO: Enable this with a debug setting in config
                    //System.out.println("Calming PigMan with anger of " + pigMan.getAnger());
                    pigMan.setAngry(false);
                }
            }
        }
    }
}
